<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>O Algoritmo Invisível – Primeira Camada</title>
    <link rel="stylesheet" href="styles.css">
    <script src="audio-manager.js"></script>
    <script src="audio-button.js"></script>
    <style>
    body {
      background: var(--bg-dark);
      color: var(--text-light);
      min-height: 100vh;
      font-family: 'Segoe UI', 'Courier New', monospace;
    }
    .container {
      max-width: 95%;
      margin: 0 auto;
      padding: 40px 20px 60px 20px;
    }
    .glass-block {
      background: rgba(27,27,31,0.6);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      padding: 32px 28px;
      margin-bottom: 32px;
      backdrop-filter: blur(10px);
    }
    h1 {
      font-size: 2.4rem;
      color: var(--neon-cyan);
      text-shadow: 0 0 12px var(--neon-cyan);
      margin-bottom: 18px;
    }
    .bullets {
      margin: 18px 0 18px 0;
      padding-left: 18px;
    }
    .bullets li {
      margin-bottom: 8px;
      font-size: 1.2rem;
      list-style: disc;
      line-height: 1.6;
    }
    .reflexao {
      font-style: italic;
      color: var(--neon-yellow);
      margin: 18px 0 0 0;
      font-size: 1.3rem;
      line-height: 1.6;
    }
    .token-form {
      display: flex;
      gap: 10px;
      margin: 30px 0 20px 0;
      align-items: center;
      justify-content: center;
    }
    .token-form input {
      padding: 12px 18px;
      border-radius: 8px;
      border: 1.5px solid var(--neon-cyan);
      background: rgba(0,255,247,0.07);
      color: var(--text-light);
      font-size: 1.1rem;
      outline: none;
      width: 320px;
      transition: border 0.2s;
    }
    .token-form input:focus {
      border: 2px solid var(--neon-cyan);
    }
    .token-form button {
      background: linear-gradient(45deg, var(--neon-cyan), var(--neon-magenta));
      color: var(--bg-dark);
      border: none;
      border-radius: 8px;
      padding: 12px 28px;
      font-weight: bold;
      font-size: 1.1rem;
      cursor: pointer;
      transition: box-shadow 0.2s, transform 0.2s;
      box-shadow: 0 0 10px var(--neon-cyan, #00FFF7);
    }
    .token-form button:hover {
      transform: translateY(-2px) scale(1.04);
      box-shadow: 0 0 18px var(--neon-magenta, #FF00E0);
    }
    .tokens-area {
      min-height: 60px;
      margin: 30px 0 10px 0;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: flex-end;
      justify-content: center;
    }
    .token-block {
      background: var(--neon-cyan);
      color: var(--bg-dark);
      border-radius: 8px;
      padding: 10px 18px;
      font-weight: bold;
      font-size: 1.1rem;
      margin-bottom: 8px;
      box-shadow: 0 0 10px var(--neon-cyan, #00FFF7);
      opacity: 0;
      transform: translateY(30px) scale(0.8);
      transition: all 0.4s cubic-bezier(.6,1.5,.5,1.1);
      position: relative;
    }
    .token-block.visible {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
    .layers-area {
      display: flex;
      gap: 18px;
      justify-content: center;
      margin: 40px 0 20px 0;
      position: relative;
      min-height: 120px;
    }
    .layer-rect {
      width: 80px;
      height: 110px;
      background: rgba(255,255,255,0.08);
      border: 2px solid var(--neon-magenta);
      border-radius: 14px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      color: var(--neon-magenta);
      box-shadow: 0 0 18px var(--neon-magenta, #FF00E0);
      cursor: pointer;
      transition: border 0.2s, box-shadow 0.2s;
    }
    .layer-rect:hover {
      border: 2.5px solid var(--neon-yellow);
      box-shadow: 0 0 24px var(--neon-yellow, #FFEA00);
      color: var(--neon-yellow);
    }
    .layer-tooltip {
      position: absolute;
      bottom: 120%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(27,27,31,0.95);
      color: var(--text-light);
      border: 1px solid var(--neon-yellow);
      border-radius: 8px;
      padding: 12px 18px;
      font-size: 1rem;
      white-space: nowrap;
      z-index: 10;
      box-shadow: 0 0 12px var(--neon-yellow, #FFEA00);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }
    .layer-rect:hover .layer-tooltip {
      opacity: 1;
    }
    .progress-area {
      margin: 40px 0 0 0;
      text-align: center;
    }
    .progress-label {
      color: var(--neon-yellow);
      font-size: 1.1rem;
      margin-bottom: 8px;
    }
    .progress-bar {
      width: 80%;
      max-width: 400px;
      height: 16px;
      background: rgba(255,255,255,0.08);
      border-radius: 8px;
      margin: 0 auto 10px auto;
      overflow: hidden;
      position: relative;
      box-shadow: 0 0 10px var(--neon-cyan, #00FFF7);
    }
    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--neon-cyan), var(--neon-yellow));
      border-radius: 8px;
      transition: width 2.2s cubic-bezier(.6,1.5,.5,1.1);
    }
    .fun-fact {
      color: var(--text-muted);
      font-size: 1rem;
      margin-top: 8px;
      font-style: italic;
    }
    .final-area {
      margin: 50px 0 0 0;
      text-align: center;
      display: none;
    }
    .final-cards-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
    }
    .final-area.show {
      display: block;
    }
    .final-area h2 {
      color: var(--neon-cyan);
      font-size: 2rem;
      margin-bottom: 12px;
    }
    .final-area p {
      color: var(--text-light);
      font-size: 1.2rem;
      margin-bottom: 18px;
      line-height: 1.6;
    }
    .final-area .btn-next {
      background: linear-gradient(45deg, var(--neon-magenta), var(--neon-yellow));
      color: var(--bg-dark);
      border: none;
      border-radius: 8px;
      padding: 15px 30px;
      font-weight: bold;
      font-size: 1.1rem;
      cursor: pointer;
      transition: box-shadow 0.2s, transform 0.2s;
      box-shadow: 0 0 10px var(--neon-magenta, #FF00E0);
    }
    .final-area .btn-next:hover {
      transform: translateY(-2px) scale(1.04);
      box-shadow: 0 0 18px var(--neon-yellow, #FFEA00);
    }
    .animated-intro .intro-title {
      animation: glitchFadeIn 1.2s;
      text-shadow: 0 0 12px var(--neon-cyan), 0 0 2px #fff;
    }
    @keyframes glitchFadeIn {
      0% { opacity: 0; transform: translateY(30px) scale(0.95);}
      60% { opacity: 1; transform: translateY(-4px) scale(1.03);}
      100% { opacity: 1; transform: translateY(0) scale(1);}
    }
    .animated-intro     .intro-desc {
      opacity: 0;
      animation: fadeInUp 1s 0.7s forwards;
      font-size: 1.2rem;
      line-height: 1.6;
    }
    @keyframes fadeInUp {
      to { opacity: 1; transform: translateY(0);}
      from { opacity: 0; transform: translateY(20px);}
    }
    .animated-bullets li {
      opacity: 0;
      transform: translateX(-30px);
      animation: fadeInLeft 0.7s forwards;
    }
    .animated-bullets li:nth-child(1) { animation-delay: 1.2s; }
    .animated-bullets li:nth-child(2) { animation-delay: 1.7s; }
    .animated-bullets li:nth-child(3) { animation-delay: 2.2s; }
    @keyframes fadeInLeft {
      to { opacity: 1; transform: translateX(0);}
      from { opacity: 0; transform: translateX(-30px);}
    }
    .neon-keyword {
      color: var(--neon-cyan);
      font-weight: bold;
      text-shadow: 0 0 8px var(--neon-cyan);
      cursor: pointer;
      border-bottom: 1.5px dashed var(--neon-cyan);
      transition: color 0.2s;
      position: relative;
    }
    .neon-keyword:hover {
      color: var(--neon-yellow);
      text-shadow: 0 0 12px var(--neon-yellow);
    }
    .animated-reflexao {
      opacity: 0;
      animation: fadeInUp 1s 2.7s forwards;
    }
    .icon {
      font-size: 1.2em;
      margin-right: 6px;
      vertical-align: middle;
    }
    .neon-tooltip {
      position: absolute;
      background: #18181c;
      color: var(--neon-cyan);
      border: 1px solid var(--neon-cyan);
      border-radius: 8px;
      padding: 8px 14px;
      font-size: 1rem;
      z-index: 1000;
      box-shadow: 0 0 12px var(--neon-cyan);
      pointer-events: none;
      white-space: nowrap;
      animation: fadeInUp 0.3s;
    }
    .final-card, .final-note, .final-reflexao {
      background: rgba(27,27,31,0.7);
      border-radius: 14px;
      box-shadow: 0 0 24px var(--neon-cyan, #00FFF7);
      margin: 0 10px 22px 10px;
      padding: 24px 22px;
      flex: 1;
      min-width: 300px;
      border: 1.5px solid var(--neon-cyan);
      animation: fadeInUp 1s;
    }
    .final-note {
      background: rgba(255,255,255,0.08);
      border: 1.5px solid var(--neon-yellow);
      color: var(--neon-yellow);
      box-shadow: 0 0 18px var(--neon-yellow, #FFEA00);
      display: flex;
      align-items: flex-start;
      gap: 10px;
      font-size: 1.2rem;
      line-height: 1.6;
    }
    .note-icon {
      font-size: 1.5em;
      margin-top: 2px;
    }
    .final-reflexao {
      background: linear-gradient(90deg, rgba(0,255,247,0.08), rgba(255,0,224,0.08));
      border: 1.5px solid var(--neon-magenta);
      color: var(--neon-magenta);
      box-shadow: 0 0 18px var(--neon-magenta, #FF00E0);
      font-size: 1.25rem;
      line-height: 1.6;
    }
    .cyber-label {
      font-size: 0.98em;
      color: var(--neon-cyan);
      letter-spacing: 1px;
      font-weight: bold;
      text-transform: uppercase;
      margin-bottom: 8px;
      display: block;
    }
    .cyber-fast {
      color: var(--neon-yellow);
      font-weight: bold;
      font-size: 1.08em;
      text-shadow: 0 0 8px var(--neon-yellow);
    }
    .neon-number {
      color: var(--neon-yellow);
      font-weight: bold;
      font-size: 1.15em;
      text-shadow: 0 0 8px var(--neon-yellow);
    }
    .animated-final {
      opacity: 0;
      transform: translateY(30px);
      animation: fadeInUp 1s forwards;
    }
    .animated-final:nth-child(1) { animation-delay: 0.2s; }
    .animated-final:nth-child(2) { animation-delay: 0.7s; }
    .animated-final:nth-child(3) { animation-delay: 1.2s; }
    .navegacao {
      position: fixed;
      right: 3vw;
      bottom: 3vh;
      display: flex;
      flex-direction: row;
      gap: 18px;
      z-index: 9999;
    }
    
    .voice-btn {
      margin: 0;
      padding: .4rem .8rem;
      border: 1px solid rgba(0,255,247,.3);
      background: rgba(0,255,247,.1);
      color: var(--neon-cyan);
      border-radius: .5rem;
      cursor: pointer;
      font-size: .9rem;
      font-weight: bold;
      transition: all 0.3s ease;
      text-shadow: 0 0 4px var(--neon-cyan);
    }
    .voice-btn:hover {
      background: rgba(0,255,247,.2);
      border-color: var(--neon-cyan);
      text-shadow: 0 0 8px var(--neon-cyan);
      transform: scale(1.05);
    }
    .voice-btn:focus {
      outline: 2px solid var(--neon-cyan);
      outline-offset: 2px;
    }
    
    /* Responsividade para as caixinhas finais */
    @media (max-width: 1200px) {
      .final-cards-container {
        flex-direction: column;
        align-items: center;
      }
      .final-card, .final-note, .final-reflexao {
        max-width: 600px;
        width: 100%;
      }
    }
    
    @media (max-width: 768px) {
      .final-card, .final-note, .final-reflexao {
        min-width: 280px;
        margin: 0 5px 15px 5px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="glass-block animated-intro">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 18px;">
        <h1 class="intro-title" style="margin-bottom: 0;">O Algoritmo Invisível</h1>
        <button id="nar-play" type="button" aria-label="Ouvir narração da página" class="voice-btn">🔊 Ouvir</button>
      </div>
      <p class="intro-desc">
        Quando você digita uma pergunta, nada mágico acontece — ela é convertida em centenas de milhares de 
        <span class="neon-keyword" data-tip="Unidades mínimas de texto para IA">tokens</span> 
        que atravessam camadas de uma rede neural gigante. É esse modelo, treinado em trilhões de palavras, que gera a resposta que você vê.
      </p>
      <ul class="bullets animated-bullets">
        <li><span class="icon">🔢</span> <strong>Tokens e Embeddings:</strong> cada palavra vira números que o modelo lê como <span class="neon-keyword" data-tip="Representação matemática de palavras">“vetores”</span>.</li>
        <li><span class="icon">🧩</span> <strong>Camadas do Modelo:</strong> sua arquitetura (<span class="neon-keyword" data-tip="Tipo de rede neural">transformer</span>) empilha dezenas a centenas de camadas que processam e refinam essas informações.</li>
        <li><span class="icon">📚</span> <strong>Treinamento:</strong> alimentado com textos da web, livros e códigos, o modelo aprende <span class="neon-keyword" data-tip="Relações matemáticas entre palavras">padrões estatísticos</span>, não “entende” no sentido humano.</li>
      </ul>
      <div class="reflexao animated-reflexao">Você sabe como suas palavras viram matemática antes de voltar como uma resposta?</div>
    </div>
    <form class="token-form" id="tokenForm" autocomplete="off">
      <input type="text" id="userInput" maxlength="60" placeholder="Digite uma frase curta..." required>
      <button type="submit">Ver tokens em ação</button>
    </form>
    <div class="tokens-area" id="tokensArea"></div>
    <div class="layers-area" id="layersArea" style="display:none;"></div>
    <div class="progress-area" id="progressArea" style="display:none;">
      <div class="progress-label">Treinamento do modelo</div>
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <div class="fun-fact" id="funFact">Este modelo foi treinado em 1,5 trilhão de tokens.</div>
    </div>
    <div class="final-area" id="finalArea" style="display: none;">
      <div class="final-cards-container">
        <div class="final-card animated-final" id="finalCard">
          <span class="cyber-label">⚡ Nenhuma mágica</span>
          <p>
            Quando você pergunta algo, seu texto é quebrado em 
            <span class="neon-number" id="finalTokenCount"></span> tokens,
            processado por um <span class="neon-keyword" data-tip="Tipo de rede neural">transformer</span> de 
            <span class="neon-number" id="finalLayerCount"></span> camadas e devolvido como resposta.<br>
            <span class="cyber-fast">Tudo isso em menos de um segundo.</span>
          </p>
        </div>
        <div class="final-note animated-final" id="finalNote">
          <span class="note-icon">ℹ️</span>
          <span>
            <strong>Nota:</strong> Esta é uma simulação educativa, mas é por essas lógicas que funcionam as <span class="neon-keyword" data-tip="Modelos que geram texto, imagem, etc.">IAs generativas</span> no estágio atual (2025).
          </span>
        </div>
        <div class="final-reflexao animated-final" id="finalReflexao">
          <span class="cyber-label">⏩ Avançar camada</span>
          <p>
            Mas essa é apenas a <span class="neon-keyword" data-tip="Você está só no começo!">primeira camada</span>...<br>
            Existem outras camadas trabalhando em paralelo, cada uma com sua função específica.<br>
            <strong>Pronto para descobrir o que há por trás?</strong>
          </p>
        </div>
      </div>
      <!-- Botão removido conforme solicitado -->
    </div>
  </div>
  <script>
    const tokenForm = document.getElementById('tokenForm');
    const userInput = document.getElementById('userInput');
    const tokensArea = document.getElementById('tokensArea');
    const layersArea = document.getElementById('layersArea');
    const progressArea = document.getElementById('progressArea');
    const progressFill = document.getElementById('progressFill');
    const finalArea = document.getElementById('finalArea');

    // Camadas simuladas
    let NUM_LAYERS = 6;
    const LAYER_TOOLTIPS_BASE = [
      'detecta padrões básicos de tokens.',
      'ajusta relações entre tokens próximos.',
      'entende contexto de frases.',
      'refina significados e dependências.',
      'integra contexto global da frase.',
      'gera a resposta final.'
    ];

    let userOriginalText = '';
    let userTokens = [];

    tokenForm.onsubmit = e => {
      e.preventDefault();
      const text = userInput.value.trim();
      if (!text) return;
      
      userOriginalText = text;
      tokensArea.innerHTML = '';
      layersArea.innerHTML = '';
      progressArea.style.display = 'none';
      finalArea.style.display = 'none'; // Ensure it's hidden initially
      layersArea.style.display = 'none';
      
      // Tokenização mais realista (simula como IAs realmente quebram texto)
      userTokens = tokenizeText(text);
      
      // Mostra contagem de tokens
      const tokenCount = document.createElement('div');
      tokenCount.style.cssText = `
        color: var(--neon-yellow);
        font-size: 1.1rem;
        margin-bottom: 20px;
        text-align: center;
        font-weight: bold;
      `;
      tokenCount.textContent = `Divisão silábica (${userTokens.length} tokens gerados)`;
      tokensArea.appendChild(tokenCount);
      
      // Cria tokens visuais com divisão silábica
      const syllabifiedText = syllabifyText(userOriginalText);
      const syllables = syllabifiedText.split(/\s+/).flatMap(word => word.split('-'));
      
      syllables.forEach((syllable, i) => {
        const tokenBlock = document.createElement('div');
        tokenBlock.className = 'token-block';
        tokenBlock.textContent = syllable;
        tokenBlock.title = `Sílaba ${i + 1}: "${syllable}"`;
        tokenBlock.style.transitionDelay = (i * 0.1) + 's';
        tokensArea.appendChild(tokenBlock);
        setTimeout(() => tokenBlock.classList.add('visible'), 100 + i * 100);
      });
      
      // Define o número de camadas igual ao número de palavras digitadas (mínimo 1)
      const wordCount = text.split(/\s+/).filter(Boolean).length;
      NUM_LAYERS = Math.max(1, wordCount);
      
      // Após tokens, inicia animação para camadas
      setTimeout(() => animateTokensThroughLayers(userTokens), 800 + syllables.length * 100);
    };

    // Função de tokenização mais realista
    function tokenizeText(text) {
      const tokens = [];
      let current = '';
      
      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        
        // Se é espaço, finaliza token atual
        if (char === ' ') {
          if (current) {
            tokens.push(current);
            current = '';
          }
          continue;
        }
        
        // Se é pontuação, pode ser token separado
        if (/[.,!?;:()"'`]/.test(char)) {
          if (current) {
            tokens.push(current);
            current = '';
          }
          tokens.push(char);
          continue;
        }
        
        // Adiciona caractere ao token atual
        current += char;
      }
      
      // Adiciona último token se existir
      if (current) {
        tokens.push(current);
      }
      
      return tokens;
    }

    // Função de divisão silábica simples
    function syllabifyText(text) {
      // Remove pontuação para divisão silábica
      const cleanText = text.replace(/[.,!?;:()"'`]/g, '');
      const words = cleanText.split(/\s+/).filter(Boolean);
      
      const syllabifiedWords = words.map(word => {
        // Divisão silábica básica (pode ser melhorada)
        const syllables = [];
        let current = '';
        
        for (let i = 0; i < word.length; i++) {
          current += word[i];
          
          // Regras básicas de divisão silábica
          const nextChar = word[i + 1];
          const isVowel = /[aeiouáéíóúâêîôûãõ]/i.test(word[i]);
          const nextIsVowel = nextChar && /[aeiouáéíóúâêîôûãõ]/i.test(nextChar);
          const nextIsConsonant = nextChar && /[bcdfghjklmnpqrstvwxyz]/i.test(nextChar);
          
          // Se encontrou uma vogal e o próximo é consoante, pode dividir
          if (isVowel && nextIsConsonant && i < word.length - 2) {
            syllables.push(current);
            current = '';
          }
        }
        
        if (current) {
          syllables.push(current);
        }
        
        return syllables.join('-');
      });
      
      return syllabifiedWords.join(' ');
    }

    function animateTokensThroughLayers(tokens) {
      tokensArea.innerHTML = '';
      layersArea.innerHTML = '';
      layersArea.style.display = 'flex';
      
      // Cria camadas com representação de tokens
      for (let i = 0; i < NUM_LAYERS; i++) {
        const layer = document.createElement('div');
        layer.className = 'layer-rect';
        
        // Cria representação visual de tokens dentro da camada
        const tokenRepresentation = document.createElement('div');
        tokenRepresentation.style.cssText = `
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 4px;
        `;
        
        // Adiciona um token por camada, mostrando o número da camada
        const sampleToken = document.createElement('div');
        sampleToken.style.cssText = `
          background: rgba(255,255,255,0.1);
          border: 1px solid var(--neon-magenta);
          border-radius: 4px;
          padding: 2px 6px;
          font-size: 0.7rem;
          color: var(--neon-magenta);
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          max-width: 60px;
        `;
        sampleToken.textContent = i + 1; // Mostra o número da camada
        sampleToken.title = `Camada ${i + 1}`; // Tooltip com o número da camada
        tokenRepresentation.appendChild(sampleToken);
        
        layer.appendChild(tokenRepresentation);
        
        // Tooltip
        const tooltip = document.createElement('div');
        tooltip.className = 'layer-tooltip';
        // Usa o texto base ou repete se houver mais camadas que tooltips
        tooltip.textContent = `Camada ${i + 1} de ${NUM_LAYERS}: ` + (LAYER_TOOLTIPS_BASE[i] || LAYER_TOOLTIPS_BASE[LAYER_TOOLTIPS_BASE.length-1]);
        layer.appendChild(tooltip);
        layersArea.appendChild(layer);
      }
      
      // Anima tokens passando pelas camadas
      let currentLayer = 0;
      function moveTokens() {
        if (currentLayer >= NUM_LAYERS) {
          // Fim: mostra barra de progresso
          showProgressBar();
          return;
        }
        
        // Mostra tokens na frente da camada atual
        tokensArea.innerHTML = '';
        
        // Adiciona contagem de tokens novamente
        const tokenCount = document.createElement('div');
        tokenCount.style.cssText = `
          color: var(--neon-yellow);
          font-size: 1.1rem;
          margin-bottom: 20px;
          text-align: center;
          font-weight: bold;
        `;
        tokenCount.textContent = `Processando ${tokens.length} tokens na Camada ${currentLayer + 1}`;
        tokensArea.appendChild(tokenCount);
        
        // Som de processamento/bipes quando aparece a mensagem
        if (typeof playProcessingSound === 'function') {
          playProcessingSound();
        }
        
        // Mostra todos os tokens com números
        for (let j = 0; j < tokens.length; j++) {
          const token = document.createElement('div');
          token.className = 'token-block visible';
          token.textContent = j + 1; // Mostra o número do token
          token.title = `Token ${j + 1}: "${tokens[j]}"`; // Tooltip com o texto original
          token.style.background = currentLayer % 2 === 0 ? 'var(--neon-cyan)' : 'var(--neon-magenta)';
          token.style.color = 'var(--bg-dark)';
          token.style.boxShadow = `0 0 10px ${currentLayer % 2 === 0 ? 'var(--neon-cyan)' : 'var(--neon-magenta)'}`;
          tokensArea.appendChild(token);
        }
        
        // Destaca camada atual
        Array.from(layersArea.children).forEach((layer, idx) => {
          layer.style.border = idx === currentLayer ? '2.5px solid var(--neon-yellow)' : '2px solid var(--neon-magenta)';
          layer.style.boxShadow = idx === currentLayer ? '0 0 24px var(--neon-yellow)' : '0 0 18px var(--neon-magenta)';
          layer.style.color = idx === currentLayer ? 'var(--neon-yellow)' : 'var(--neon-magenta)';
        });
        
        currentLayer++;
        setTimeout(moveTokens, 800);
      }
      moveTokens();
    }

    function showProgressBar() {
      // Não limpar tokensArea nem esconder progressArea
      layersArea.style.display = 'none';
      progressArea.style.display = 'block';
      progressFill.style.width = '0%';
      setTimeout(() => {
        progressFill.style.width = '100%';
      }, 100);
      setTimeout(() => {
        progressArea.style.display = 'none';
        
        // Exibição das caixinhas finais lado a lado
        const card = document.getElementById('finalCard');
        const note = document.getElementById('finalNote');
        const ref = document.getElementById('finalReflexao');
        const finalArea = document.getElementById('finalArea');
        console.log('Exibindo caixinhas finais:', {card, note, ref, finalArea});
        finalArea.style.display = 'block';
        
        // Mostra caixinhas com sons sequenciais
        setTimeout(() => {
          card.style.display = 'block';
          // Som para "Nenhuma mágica"
          if (typeof playConfirmationSound === 'function') {
            playConfirmationSound();
          }
        }, 400);
        
        setTimeout(() => {
          note.style.display = 'block';
          // Som para "Nota" (mesmo som)
          if (typeof playConfirmationSound === 'function') {
            playConfirmationSound();
          }
        }, 800);
        
        setTimeout(() => {
          ref.style.display = 'block';
          // Som para "Avançar" (mesmo som)
          if (typeof playConfirmationSound === 'function') {
            playConfirmationSound();
          }
        }, 1200);
      }, 2400);
    }
  </script>
  <script>
    // Tooltip para palavras-chave
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.neon-keyword').forEach(el => {
        el.addEventListener('mouseenter', function() {
          const tip = document.createElement('div');
          tip.className = 'neon-tooltip';
          tip.textContent = el.getAttribute('data-tip');
          document.body.appendChild(tip);
          const rect = el.getBoundingClientRect();
          tip.style.left = rect.left + window.scrollX + 'px';
          tip.style.top = rect.bottom + window.scrollY + 6 + 'px';
          el._tip = tip;
        });
        el.addEventListener('mouseleave', function() {
          if (el._tip) el._tip.remove();
        });
      });
    });
  </script>
  <script>
    // Preenche os números de tokens e camadas com destaque visual
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof userTokens !== 'undefined' && userTokens.length) {
        document.getElementById('finalTokenCount').textContent = userTokens.length;
        document.getElementById('finalLayerCount').textContent = userTokens.length;
      }
    });
  </script>

  <!-- Texto da narração -->
  <script type="application/json" id="nar-page">
  {
    "lang": "pt-BR",
    "rate": 1.0,
    "pitch": 1.0,
    "text": "O Algoritmo Invisível. Quando você digita uma pergunta, nada mágico acontece. Ela é convertida em centenas de milhares de tokens. Que atravessam camadas de uma rede neural gigante. Cada palavra vira números. Que o modelo lê como vetores. Dezenas a centenas de camadas. Processam e refinam essas informações. Alimentado com trilhões de palavras. O modelo aprende padrões estatísticos. Não entende no sentido humano. Você sabe como suas palavras viram matemática? Antes de voltar como uma resposta? Nenhuma mágica. Tudo isso em menos de um segundo. Mas essa é apenas a primeira camada. Existem outras camadas trabalhando em paralelo. Pronto para descobrir o que há por trás?"
  }
  </script>

  <script>
  (function () {
    const btn = document.getElementById('nar-play');
    if (!btn) return;

    let playing = false;
    let utter = null;

    function loadNarration() {
      const el = document.getElementById('nar-page');
      if (el) {
        try { return JSON.parse(el.textContent.trim()); }
        catch { return { lang: 'pt-BR', rate: 1.0, pitch: 1.0, text: el.textContent.trim() }; }
      }
      return { lang: 'pt-BR', rate: 1.0, pitch: 1.0, text: '' };
    }

    // Função para narração automática
    function autoNarrate() {
      if (typeof isAudioEnabled === 'function' && isAudioEnabled()) {
        const data = loadNarration();
        const text = data.text;
        if (text) {
          // Remove emojis e caracteres especiais para narração
          const cleanText = text
            .replace(/[\u{1F600}-\u{1F64F}]/gu, '') // emojis de rosto
            .replace(/[\u{1F300}-\u{1F5FF}]/gu, '') // símbolos e pictogramas
            .replace(/[\u{1F680}-\u{1F6FF}]/gu, '') // transporte e mapas
            .replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '') // bandeiras
            .replace(/[\u{2600}-\u{26FF}]/gu, '') // símbolos diversos
            .replace(/[\u{2700}-\u{27BF}]/gu, '') // símbolos diversos
            .replace(/[🤖📦⚠️🔓💎⚡🔒🌟💥🎯📱]/g, '') // emojis específicos do projeto
            .replace(/\s+/g, ' ') // remove espaços múltiplos
            .trim();
          
          if (cleanText) {
            window.speechSynthesis.cancel();
            utter = new SpeechSynthesisUtterance(cleanText);
            utter.lang = data.lang || 'pt-BR';
            utter.rate = data.rate || 1.0;
            utter.pitch = data.pitch || 1.0;
            
            utter.onend = () => {
              playing = false;
              btn.textContent = '🔊 Ouvir';
              btn.setAttribute('aria-label', 'Ouvir narração da página');
            };
            
            speechSynthesis.speak(utter);
            playing = true;
            btn.textContent = '⏸️ Pausar';
            btn.setAttribute('aria-label', 'Pausar narração');
          }
        }
      }
    }

    async function toggle() {
      if (!('speechSynthesis' in window)) {
        alert('Seu navegador não suporta leitura por voz.');
        return;
      }
      // Verifica se o áudio está habilitado
      if (typeof isAudioEnabled === 'function' && !isAudioEnabled()) {
        return;
      }

      if (playing) {
        window.speechSynthesis.cancel();
        btn.textContent = '🔊 Ouvir';
        btn.setAttribute('aria-label', 'Ouvir narração da página');
        playing = false;
        return;
      }

      const data = (typeof loadNarration === 'function') ? await loadNarration() : null;
      const text = data && data.text ? data.text : '';
      if (!text) return;

      window.speechSynthesis.cancel();
      utter = new SpeechSynthesisUtterance(text);
      utter.lang = data.lang || 'pt-BR';
      utter.rate = data.rate || 1.0;
      utter.pitch = data.pitch || 1.0;

      utter.onend = () => {
        playing = false;
        btn.textContent = '🔊 Ouvir';
        btn.setAttribute('aria-label', 'Ouvir narração da página');
      };

      speechSynthesis.speak(utter);
      playing = true;
      btn.textContent = '⏸️ Pausar';
      btn.setAttribute('aria-label', 'Pausar narração');
    }

    btn.addEventListener('click', toggle);
    window.addEventListener('beforeunload', () => speechSynthesis.cancel());
    
    // Narração automática quando a página carrega
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(autoNarrate, 1000); // Aguarda 1 segundo para garantir que tudo carregou
    });
  })();
  </script>

  <div class="navegacao">
    <a href="3-transition.html" class="btn-neon">Voltar</a>
    <a href="5-segunda-camada.html" class="btn-neon">Próximo</a>
  </div>
</body>
</html> 