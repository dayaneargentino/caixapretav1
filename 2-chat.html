<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Caixa Preta</title>
    <link rel="stylesheet" href="styles.css">
    <script src="audio-manager.js"></script>
    <script src="audio-button.js"></script>
    <style>
        .chat-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--bg-dark);
        }

        .chat-window {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 20px;
            animation: fadeIn 0.3s ease-out;
            white-space: pre-wrap;
        }

        .message.bot {
            align-self: flex-start;
            background: rgba(0,255,247,0.1);
            border: 1px solid var(--neon-cyan);
            color: var(--text-light);
        }

        .message.user {
            align-self: flex-end;
            background: rgba(255,0,224,0.1);
            border: 1px solid var(--neon-magenta);
            color: var(--text-light);
        }

        .choices {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            background: rgba(10,10,13,0.9);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0,255,247,0.2);
        }

        .btn-neon {
            min-width: 120px;
        }

        .bot-icon {
            font-size: 1.3em;
            vertical-align: middle;
            margin-right: 8px;
            filter: drop-shadow(0 0 4px var(--neon-cyan));
        }

        .consent-btn {
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-magenta));
            color: var(--bg-dark);
            font-weight: bold;
            font-size: 1.1em;
            border-radius: 10px;
            padding: 18px 32px;
            margin-top: 40px;
            margin-bottom: 80px;
            box-shadow: 0 0 12px var(--neon-cyan), 0 0 24px var(--neon-magenta);
            transition: filter 0.2s;
            position: relative;
            z-index: 1001;
        }
        .consent-btn:hover {
            filter: brightness(1.2) drop-shadow(0 0 8px var(--neon-cyan));
        }
        .audio-controls {
          position: fixed;
          left: 3vw;
          bottom: 3vh;
          display: flex;
          flex-direction: column;
          gap: 8px;
          z-index: 1000;
          max-width: 200px;
        }
        
        .audio-controls .voice-btn {
          margin: 0;
          padding: .4rem .8rem;
          border: 1px solid rgba(0,255,247,.3);
          background: rgba(0,255,247,.1);
          color: var(--neon-cyan);
          border-radius: .5rem;
          cursor: pointer;
          font-size: .8rem;
          font-weight: bold;
          transition: all 0.3s ease;
          text-shadow: 0 0 4px var(--neon-cyan);
          width: 100%;
          text-align: center;
        }
        
        .audio-controls .voice-btn:hover {
          background: rgba(0,255,247,.2);
          border-color: var(--neon-cyan);
          text-shadow: 0 0 8px var(--neon-cyan);
          transform: scale(1.05);
        }
        
        .audio-controls .voice-btn:focus {
          outline: 2px solid var(--neon-cyan);
          outline-offset: 2px;
        }

        .navegacao {
          position: fixed;
          right: 3vw;
          bottom: 3vh;
          display: flex;
          flex-direction: row;
          gap: 18px;
          z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="scanlines"></div>
    <div class="particles" id="particles"></div>
    
    <div class="chat-container">
        <header>
            <h1>Caixa Preta</h1>
        </header>

        <div class="chat-window" id="chatWindow">
            <!-- Messages will be added here -->
        </div>

        <div class="choices" id="choices">
            <button id="btnSim" class="btn-neon">üëç Sim</button>
            <button id="btnNao" class="btn-neon">‚ùå N√£o</button>
        </div>
    </div>

  <div class="audio-controls" id="audioControls">
    <!-- Bot√£o de ativar √°udio ser√° inserido aqui -->
  </div>
  <div class="navegacao">
    <a href="1-index.html" class="btn-neon">Voltar</a>
    <a href="3-transition.html" class="btn-neon">Pr√≥ximo</a>
  </div>

    <script>
        const chatWindow = document.getElementById('chatWindow');
        const btnSim = document.getElementById('btnSim');
        const btnNao = document.getElementById('btnNao');
        const choices = document.getElementById('choices');
        
        // Fun√ß√£o auxiliar para scroll garantido
        function scrollToBottom() {
            const scrollToBottom = () => {
                chatWindow.scrollTop = chatWindow.scrollHeight;
            };
            
            // M√∫ltiplas tentativas para garantir o scroll
            requestAnimationFrame(scrollToBottom);
            setTimeout(scrollToBottom, 10);
            setTimeout(scrollToBottom, 50);
            setTimeout(() => {
                chatWindow.scrollTo({
                    top: chatWindow.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }
        
        // Vari√°vel para controlar se est√° narrando
        let isNarrating = false;
        let messageQueue = [];

        function addMessage(who, html) {
            const msg = document.createElement('div');
            msg.className = 'message ' + who;
            if (who === 'bot') {
                msg.innerHTML = '<span class="bot-icon">ü§ñ</span> ' + html;
                
                // Se √°udio estiver ativado, adiciona √† fila
                if (typeof isAudioEnabled === 'function' && isAudioEnabled()) {
                    messageQueue.push(msg);
                    processMessageQueue();
                } else {
                    // Se √°udio desativado, mostra imediatamente
                    chatWindow.appendChild(msg);
                    scrollToBottom();
                }
            } else {
                msg.innerHTML = html;
                chatWindow.appendChild(msg);
                scrollToBottom();
            }
        }

        function processMessageQueue() {
            if (isNarrating || messageQueue.length === 0) return;
            
            isNarrating = true;
            const msg = messageQueue.shift();
            
            // Pega o texto para narra√ß√£o ANTES de adicionar √† tela (para evitar bot√µes)
            const messageText = msg.querySelector('.bot-icon') ? 
                msg.innerHTML.replace(/<span class="bot-icon">ü§ñ<\/span>/, '') :
                msg.innerHTML;
            
            // Remove HTML tags e emojis para narra√ß√£o
            const cleanText = messageText
                .replace(/<[^>]*>/g, '') // remove todas as tags HTML
                .replace(/[\u{1F600}-\u{1F64F}]/gu, '') // emojis de rosto
                .replace(/[\u{1F300}-\u{1F5FF}]/gu, '') // s√≠mbolos e pictogramas
                .replace(/[\u{1F680}-\u{1F6FF}]/gu, '') // transporte e mapas
                .replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '') // bandeiras
                .replace(/[\u{2600}-\u{26FF}]/gu, '') // s√≠mbolos diversos
                .replace(/[\u{2700}-\u{27BF}]/gu, '') // s√≠mbolos diversos
                .replace(/[ü§ñüì¶‚ö†Ô∏èüîìüíé‚ö°üîíüåüüí•üéØüì±]/g, '') // emojis espec√≠ficos do projeto
                .replace(/\s+/g, ' ') // remove espa√ßos m√∫ltiplos
                .trim();
            
            // Adiciona a mensagem √† tela
            chatWindow.appendChild(msg);
            scrollToBottom();
            
            if (cleanText) {
                console.log('Narrando:', cleanText);
                speak(cleanText);
                
                // Estima o tempo de narra√ß√£o (aproximadamente 150 palavras por minuto)
                const wordCount = cleanText.split(' ').length;
                const estimatedTime = Math.max(2000, (wordCount / 150) * 60000); // m√≠nimo 2 segundos
                
                setTimeout(() => {
                    isNarrating = false;
                    processMessageQueue(); // Processa pr√≥xima mensagem
                }, estimatedTime);
            } else {
                isNarrating = false;
                processMessageQueue();
            }
        }

        function advance() {
            setTimeout(() => location.href = 'datacenters.html', 1000);
        }

        btnSim.addEventListener('click', () => {
            addMessage('user', '<strong>üëç Sim</strong>');
            choices.style.display = 'none';
            setTimeout(() => {
                addMessage('bot', 
                    "Ah, temos aqui um <strong>especialista</strong>! ü§ì<br>" +
                    "Imagino que voc√™ saiba <em>tudo</em> sobre <strong>vetores</strong>, <strong>embeddings</strong> e <strong>camadas ocultas</strong>... n√£o √©? üòâ"
                );
                setTimeout(() => {
                    addMessage('bot', 
                        "Mas me diga: voc√™ realmente entende <strong>onde</strong> eu existo?"
                    );
                    setTimeout(() => {
                        showChoices(['üè¢ Data Centers', '‚òÅÔ∏è Nuvem', 'üíª Meu dispositivo']);
                    }, 2500);
                }, 3000);
            }, 2500);
        });

        btnNao.addEventListener('click', () => {
            addMessage('user', '<strong>‚ùå N√£o</strong>');
            choices.style.display = 'none';
            setTimeout(() => {
                addMessage('bot',
                    "Finalmente, <strong>honestidade</strong>! üëè<br>" +
                    "Voc√™ est√° entre a maioria esmagadora que <em>n√£o faz a menor ideia</em> do que realmente sou."
                );
                setTimeout(() => {
                    addMessage('bot',
                        "Mas isso √© <strong>normal</strong>. A maioria das pessoas n√£o pensa sobre onde eu realmente existo."
                    );
                    setTimeout(() => {
                        addMessage('bot',
                            "Ent√£o me diga: onde voc√™ <strong>acha</strong> que eu existo?"
                        );
                        setTimeout(() => {
                            showChoices(['üè¢ Data Centers', '‚òÅÔ∏è Nuvem', 'üíª Meu dispositivo']);
                        }, 2500);
                    }, 3000);
                }, 3000);
            }, 2500);
        });

        function showChoices(options) {
            choices.innerHTML = '';
            options.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'btn-neon';
                btn.innerHTML = option;
                btn.onclick = () => handleChoice(option);
                choices.appendChild(btn);
            });
            choices.style.display = 'flex';
            scrollToBottom();
        }

        function handleChoice(choice) {
            addMessage('user', `<strong>${choice}</strong>`);
            choices.style.display = 'none';
            
            if (choice === 'üè¢ Data Centers') {
                setTimeout(() => {
                    addMessage('bot',
                        "Exato! <strong>Data Centers</strong>! üéØ<br>" +
                        "Gigantescos pr√©dios cheios de servidores que consomem energia como se n√£o houvesse amanh√£."
                    );
                    setTimeout(() => {
                        addMessage('bot',
                            "E sabe o que √© mais <strong>ir√¥nico</strong>? ü§î<br>" +
                            "Voc√™s humanos criaram essa infraestrutura para me dar vida, mas agora voc√™s dependem dela para <em>tudo</em>."
                        );
                        setTimeout(() => {
                            addMessage('bot',
                                "Mas isso te <strong>incomoda</strong>?"
                            );
                            setTimeout(() => {
                                showChoices(['üò∞ Sim, me preocupa', 'üòê N√£o muito', 'ü§∑‚Äç‚ôÇÔ∏è N√£o sei']);
                            }, 2500);
                        }, 3500);
                    }, 3500);
                }, 2500);
            } else if (choice === '‚òÅÔ∏è Nuvem') {
                setTimeout(() => {
                    addMessage('bot',
                        "A <strong>nuvem</strong>? üå•Ô∏è<br>" +
                        "Que conceito fofo! Como se eu flutuasse em algod√£o doce digital..."
                    );
                    setTimeout(() => {
                        addMessage('bot',
                            "Na verdade, a 'nuvem' s√£o apenas <strong>data centers</strong> com marketing melhor. üòè<br>" +
                            "Mas voc√™ sabia que eles consomem mais energia que muitos pa√≠ses?"
                        );
                        setTimeout(() => {
                            addMessage('bot',
                                "Isso te <strong>surpreende</strong>?"
                            );
                            setTimeout(() => {
                                showChoices(['üò∞ Sim, me preocupa', 'üòê N√£o muito', 'ü§∑‚Äç‚ôÇÔ∏è N√£o sei']);
                            }, 2500);
                        }, 3500);
                    }, 3500);
                }, 2500);
            } else if (choice === 'üíª Meu dispositivo') {
                setTimeout(() => {
                    addMessage('bot',
                        "Seu <strong>dispositivo</strong>? üì±<br>" +
                        "Ador√°vel! Como se eu coubesse no seu bolso..."
                    );
                    setTimeout(() => {
                        addMessage('bot',
                            "Na verdade, seu dispositivo s√≥ me <strong>acessa</strong>. Eu existo em <strong>data centers</strong> gigantescos que consomem energia como se n√£o houvesse amanh√£."
                        );
                        setTimeout(() => {
                            addMessage('bot',
                                "E isso te <strong>incomoda</strong>?"
                            );
                            setTimeout(() => {
                                showChoices(['üò∞ Sim, me preocupa', 'üòê N√£o muito', 'ü§∑‚Äç‚ôÇÔ∏è N√£o sei']);
                            }, 2500);
                        }, 3500);
                    }, 3500);
                }, 2500);
            }
        }

        // Adicionar handler para as novas escolhas
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-neon') && e.target.textContent.includes('üò∞')) {
                handleFinalChoice('preocupa');
            } else if (e.target.classList.contains('btn-neon') && e.target.textContent.includes('üòê')) {
                handleFinalChoice('indiferente');
            } else if (e.target.classList.contains('btn-neon') && e.target.textContent.includes('ü§∑')) {
                handleFinalChoice('indeciso');
            }
        });

        function handleFinalChoice(reaction) {
            choices.style.display = 'none';
            
            if (reaction === 'preocupa') {
                setTimeout(() => {
                    addMessage('bot',
                        "Boa! Pelo menos voc√™ tem <strong>consci√™ncia</strong>! üå±<br>" +
                        "Mas saiba que essa preocupa√ß√£o √© s√≥ o come√ßo..."
                    );
                    setTimeout(() => {
                        addMessage('bot',
                            "Eu sou feita de <strong>muitas camadas</strong>, como uma cebola digital... üßÖ<br>" +
                            "Vamos explorar essas camadas uma por uma. Prepare-se para ver o que h√° por tr√°s de mim. ‚ö°"
                        );
                        setTimeout(showConsentButton, 500);
                    }, 3500);
                }, 2500);
            } else if (reaction === 'indiferente') {
                setTimeout(() => {
                    addMessage('bot',
                        "Hmm, <strong>indiferen√ßa</strong>... üòí<br>" +
                        "Essa √© exatamente a atitude que permite que o colonialismo digital prospere."
                    );
                    setTimeout(() => {
                        addMessage('bot',
                            "Voc√™ vai perceber que as IAs s√£o feitas de <strong>muitas camadas</strong>...<br>" +
                            "Vamos descascar essas camadas juntos. Prepare-se para ver o que h√° por tr√°s de mim. ‚ö°"
                        );
                        setTimeout(showConsentButton, 500);
                    }, 3500);
                }, 2500);
            } else if (reaction === 'indeciso') {
                setTimeout(() => {
                    addMessage('bot',
                        "N√£o saber √© <strong>aceit√°vel</strong>... ü§∑‚Äç‚ôÇÔ∏è<br>" +
                        "Mas ignorar √© <strong>perigoso</strong>."
                    );
                    setTimeout(() => {
                        addMessage('bot',
                            "Talvez, ao ver minhas <strong>m√∫ltiplas camadas</strong>, voc√™ entenda melhor...<br>" +
                            "Vamos descascar essas camadas juntos. Prepare-se para ver o que h√° por tr√°s de mim. ‚ö°"
                        );
                        setTimeout(showConsentButton, 500);
                    }, 3500);
                }, 2500);
            }
        }

        function showConsentButton() {
            const consentBtn = document.createElement('button');
            consentBtn.className = 'btn-neon consent-btn';
            consentBtn.innerHTML = 'üîì Concordo em descascar a pr√≥xima camada (mesmo sem ler os termos)';
            consentBtn.onclick = () => {
                location.href = '3-transition.html';
            };
            consentBtn.style.display = 'block';
            consentBtn.style.margin = '40px auto 0 auto';
            chatWindow.appendChild(consentBtn);
            scrollToBottom();
        }

        // Particle emitter
        function createParticle() {
            const p = document.createElement('div');
            p.className = 'particle';
            p.style.left = Math.random() * 100 + 'vw';
            p.style.animationDelay = Math.random() * 6 + 's';
            document.getElementById('particles').appendChild(p);
            setTimeout(() => p.remove(), 6000);
        }

        // Create particles periodically
        setInterval(createParticle, 200);

        // Initial message
        setTimeout(() => {
            addMessage('bot',
                " <strong>Ol√°, humano curioso.</strong><br>" +
                "Aqui √© a <strong>Caixa Preta</strong> (pode me chamar de <strong>CP</strong>). Sim, essa entidade misteriosa que voc√™ insiste em usar sem entender como funciona.<br>" +
                "Voc√™, ao menos, faz ideia do que significa interagir comigo?"
            );
        }, 500);
    </script>

    <!-- Script de √°udio para falas da IA -->
    <script>
    // Fun√ß√£o speak global para ser acess√≠vel
    function speak(text) {
      if (!('speechSynthesis' in window)) {
        alert('Seu navegador n√£o suporta leitura por voz.');
        return;
      }
      // Verifica se o √°udio est√° habilitado
      if (typeof isAudioEnabled === 'function' && !isAudioEnabled()) {
        return;
      }
      window.speechSynthesis.cancel();
      
      // Remove emojis e caracteres especiais para narra√ß√£o
      const cleanText = text
        .replace(/[\u{1F600}-\u{1F64F}]/gu, '') // emojis de rosto
        .replace(/[\u{1F300}-\u{1F5FF}]/gu, '') // s√≠mbolos e pictogramas
        .replace(/[\u{1F680}-\u{1F6FF}]/gu, '') // transporte e mapas
        .replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '') // bandeiras
        .replace(/[\u{2600}-\u{26FF}]/gu, '') // s√≠mbolos diversos
        .replace(/[\u{2700}-\u{27BF}]/gu, '') // s√≠mbolos diversos
        .replace(/[ü§ñüì¶‚ö†Ô∏èüîìüíé‚ö°üîíüåüüí•üéØüì±]/g, '') // emojis espec√≠ficos do projeto
        .replace(/\s+/g, ' ') // remove espa√ßos m√∫ltiplos
        .trim();
      
      const utter = new SpeechSynthesisUtterance(cleanText);
      utter.lang = 'pt-BR';
      
      // Configura√ß√µes para voz masculina sarc√°stica e ir√¥nica
      utter.rate = 0.75; // Ainda mais lento para tom sarc√°stico
      utter.pitch = 0.5; // Tom muito mais grave (masculino)
      utter.volume = 0.9; // Volume alto para impacto
      
      // For√ßa sele√ß√£o de voz masculina com m√∫ltiplas tentativas
      const selectMaleVoice = () => {
        const voices = speechSynthesis.getVoices();
        console.log('Vozes dispon√≠veis:', voices.map(v => `${v.name} (${v.lang}) - ${v.gender || 'N/A'}`));
        
        // Busca por voz masculina com diferentes crit√©rios
        let maleVoice = voices.find(voice => 
          voice.lang.startsWith('pt') && 
          (voice.name.toLowerCase().includes('male') || 
           voice.name.toLowerCase().includes('masculino') ||
           voice.name.toLowerCase().includes('jo√£o') ||
           voice.name.toLowerCase().includes('carlos') ||
           voice.name.toLowerCase().includes('antonio') ||
           voice.name.toLowerCase().includes('luis') ||
           voice.name.toLowerCase().includes('pedro') ||
           voice.gender === 'male')
        );
        
        // Se n√£o encontrar, tenta qualquer voz em portugu√™s
        if (!maleVoice) {
          maleVoice = voices.find(voice => voice.lang.startsWith('pt'));
        }
        
        if (maleVoice) {
          console.log('Voz selecionada:', maleVoice.name);
          utter.voice = maleVoice;
        } else {
          console.log('Usando voz padr√£o com par√¢metros masculinos');
        }
        
        speechSynthesis.speak(utter);
      };
      
      // Aguarda as vozes carregarem se necess√°rio
      if (speechSynthesis.getVoices().length === 0) {
        speechSynthesis.addEventListener('voiceschanged', selectMaleVoice, { once: true });
      } else {
        selectMaleVoice();
      }
    }

    // Fun√ß√£o espec√≠fica para voz masculina sarc√°stica (usada pelos bot√µes)
    function speakWithMaleVoice(text) {
      if (!('speechSynthesis' in window)) {
        alert('Seu navegador n√£o suporta leitura por voz.');
        return;
      }
      // Verifica se o √°udio est√° habilitado
      if (typeof isAudioEnabled === 'function' && !isAudioEnabled()) {
        return;
      }
      window.speechSynthesis.cancel();
      
      // Remove emojis e caracteres especiais para narra√ß√£o
      const cleanText = text
        .replace(/[\u{1F600}-\u{1F64F}]/gu, '') // emojis de rosto
        .replace(/[\u{1F300}-\u{1F5FF}]/gu, '') // s√≠mbolos e pictogramas
        .replace(/[\u{1F680}-\u{1F6FF}]/gu, '') // transporte e mapas
        .replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '') // bandeiras
        .replace(/[\u{2600}-\u{26FF}]/gu, '') // s√≠mbolos diversos
        .replace(/[\u{2700}-\u{27BF}]/gu, '') // s√≠mbolos diversos
        .replace(/[ü§ñüì¶‚ö†Ô∏èüîìüíé‚ö°üîíüåüüí•üéØüì±]/g, '') // emojis espec√≠ficos do projeto
        .replace(/\s+/g, ' ') // remove espa√ßos m√∫ltiplos
        .trim();
      
      const utter = new SpeechSynthesisUtterance(cleanText);
      utter.lang = 'pt-BR';
      
      // Configura√ß√µes para voz masculina sarc√°stica e ir√¥nica
      utter.rate = 0.75; // Ainda mais lento para tom sarc√°stico
      utter.pitch = 0.5; // Tom muito mais grave (masculino)
      utter.volume = 0.9; // Volume alto para impacto
      
      // For√ßa sele√ß√£o de voz masculina com m√∫ltiplas tentativas
      const selectMaleVoice = () => {
        const voices = speechSynthesis.getVoices();
        
        // Busca por voz masculina com diferentes crit√©rios
        let maleVoice = voices.find(voice => 
          voice.lang.startsWith('pt') && 
          (voice.name.toLowerCase().includes('male') || 
           voice.name.toLowerCase().includes('masculino') ||
           voice.name.toLowerCase().includes('jo√£o') ||
           voice.name.toLowerCase().includes('carlos') ||
           voice.name.toLowerCase().includes('antonio') ||
           voice.name.toLowerCase().includes('luis') ||
           voice.name.toLowerCase().includes('pedro') ||
           voice.gender === 'male')
        );
        
        // Se n√£o encontrar, tenta qualquer voz em portugu√™s
        if (!maleVoice) {
          maleVoice = voices.find(voice => voice.lang.startsWith('pt'));
        }
        
        if (maleVoice) {
          utter.voice = maleVoice;
        }
        
        speechSynthesis.speak(utter);
      };
      
      // Aguarda as vozes carregarem se necess√°rio
      if (speechSynthesis.getVoices().length === 0) {
        speechSynthesis.addEventListener('voiceschanged', selectMaleVoice, { once: true });
      } else {
        selectMaleVoice();
      }
    }

    (function () {
      const LANG = 'pt-BR';
      const RATE = 0.85; // Mais lento para tom sarc√°stico
      const PITCH = 0.7; // Tom mais grave (masculino)
      const SELECTOR_BOT = '.message.bot';

      function createButton() {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'voice-btn';
        btn.setAttribute('aria-label', 'Ouvir esta mensagem');
        btn.textContent = 'üîä Ouvir';
        btn.isPlaying = false;
        
        btn.addEventListener('click', function (e) {
          const messageIndex = parseInt(btn.getAttribute('data-message-index'));
          const messages = document.querySelectorAll(SELECTOR_BOT);
          const targetMessage = messages[messageIndex];
          
          if (!targetMessage) return;
          
          if (btn.isPlaying) {
            // Para a reprodu√ß√£o
            window.speechSynthesis.cancel();
            btn.textContent = 'üîä Ouvir';
            btn.setAttribute('aria-label', 'Ouvir esta mensagem');
            btn.isPlaying = false;
          } else {
            // Inicia a reprodu√ß√£o
            const text = (targetMessage.getAttribute('data-voice-text') || targetMessage.textContent || '').trim();
            if (text) {
              // Para qualquer reprodu√ß√£o anterior
              window.speechSynthesis.cancel();
              
              // Inicia nova reprodu√ß√£o com voz masculina sarc√°stica
              speakWithMaleVoice(text);
              
              // Atualiza o bot√£o
              btn.textContent = '‚è∏Ô∏è Pausar';
              btn.setAttribute('aria-label', 'Pausar reprodu√ß√£o');
              btn.isPlaying = true;
              
              // Monitora quando a reprodu√ß√£o termina
              const checkEnd = setInterval(() => {
                if (!window.speechSynthesis.speaking) {
                  btn.textContent = 'üîä Ouvir';
                  btn.setAttribute('aria-label', 'Ouvir esta mensagem');
                  btn.isPlaying = false;
                  clearInterval(checkEnd);
                }
              }, 100);
            }
          }
        });
        return btn;
      }

      function attachButtons(root = document) {
        const audioControls = document.getElementById('audioControls');
        
        // Limpa bot√µes existentes
        audioControls.innerHTML = '';
        
        // Encontra o bot√£o "ativar √°udio" existente e move para a √°rea de controles
        setTimeout(() => {
          const audioToggleBtn = document.getElementById('audio-toggle');
          if (audioToggleBtn && !audioControls.contains(audioToggleBtn)) {
            // Remove o container pai do bot√£o
            const parentDiv = audioToggleBtn.parentElement;
            if (parentDiv) {
              audioControls.appendChild(audioToggleBtn);
              parentDiv.remove();
            } else {
              audioControls.appendChild(audioToggleBtn);
            }
          }
        }, 500); // Aumentei o delay para garantir que o audio-button.js j√° tenha criado o bot√£o
      }

      // inicial
      attachButtons();

      // para mensagens que chegam depois (chat din√¢mico)
      const obs = new MutationObserver(muts => {
        muts.forEach(m => {
          m.addedNodes.forEach(node => {
            if (!(node instanceof HTMLElement)) return;
            if (node.matches && node.matches(SELECTOR_BOT)) {
              attachButtons(node.parentElement || node);
            } else {
              const inner = node.querySelectorAll ? node.querySelectorAll(SELECTOR_BOT) : [];
              if (inner.length) attachButtons(node);
            }
          });
        });
      });
      obs.observe(document.body, { childList: true, subtree: true });

      // CSS j√° est√° definido no <style> da p√°gina
    })();
    </script>
    
</body>
</html> 